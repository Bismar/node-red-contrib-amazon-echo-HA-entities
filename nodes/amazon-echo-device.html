<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">

  <!-- Hidden inputs (these are what Node-RED saves) -->
  <input type="hidden" id="node-input-haAreaId">
  <input type="hidden" id="node-input-haLabelId">
  <input type="hidden" id="node-input-haDomain">
  <input type="hidden" id="node-input-haDeviceId">
  <input type="hidden" id="node-input-haEntityId">

  <!-- NAME -->
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
  </div>

  <!-- SERVER -->
  <div class="form-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- AREA -->
  <div class="form-row">
    <label for="haAreaSelect"><i class="fa fa-building"></i> Area</label>
    <select id="haAreaSelect" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <!-- LABEL -->
  <div class="form-row">
    <label for="haLabelSelect"><i class="fa fa-tag"></i> Label</label>
    <select id="haLabelSelect" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <!-- COMPONENT TYPE -->
  <div class="form-row">
    <label for="haDomainSelect"><i class="fa fa-cube"></i> Component type</label>
    <select id="haDomainSelect" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- DEVICE -->
  <div class="form-row">
    <label for="haDeviceSelect"><i class="fa fa-cubes"></i> Device</label>
    <select id="haDeviceSelect" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <!-- ENTITY -->
  <div class="form-row">
    <label for="haEntitySelect"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="haEntitySelect" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- CLEAR FILTERS BUTTON -->
  <div class="form-row" style="margin-top:8px;">
    <label></label>
    <div style="margin-left:0;">
      <button id="ha-clear-filters" type="button" class="red-ui-button">
        <i class="fa fa-times"></i> Clear all filters
      </button>
    </div>
  </div>

  <!-- MODES -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <!-- ATTRIBUTES -->
  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs"
         style="max-height:240px; overflow:auto; background:#fafafa; border:1px solid #ccc; padding:6px;"></pre>
  </div>

</script>


<script type="text/javascript">
(function () {

RED.nodes.registerType("amazon-echo-device-ha-entities", {
  category: "amazon",
  color: "#FFD580",
  icon: "amazon-echo-device.svg",
  paletteLabel: "amazon echo device (HA)",
  inputs: 1,
  outputs: 1,

  defaults: {
    name:       { value:"" },
    haServer:   { value:"", type:"server" },
    haAreaId:   { value:"" },
    haLabelId:  { value:"" },
    haDomain:   { value:"" },
    haDeviceId: { value:"" },
    haEntityId: { value:"" }
  },

  label() { return this.name || "Amazon Echo Device (HA)"; },

  oneditsave: function () {
    // Save the values from the dropdowns into Node-RED config fields
    $("#node-input-haAreaId").val( $("#haAreaSelect").val() );
    $("#node-input-haLabelId").val( $("#haLabelSelect").val() );
    $("#node-input-haDomain").val( $("#haDomainSelect").val() );
    $("#node-input-haDeviceId").val( $("#haDeviceSelect").val() );
    $("#node-input-haEntityId").val( $("#haEntitySelect").val() );
  },

  oneditprepare() {

    const $server = $("#node-input-haServer");

    const $area   = $("#haAreaSelect");
    const $label  = $("#haLabelSelect");
    const $domain = $("#haDomainSelect");
    const $device = $("#haDeviceSelect");
    const $entity = $("#haEntitySelect");

    const $areaC   = $("#ha-area-count");
    const $labelC  = $("#ha-label-count");
    const $domainC = $("#ha-domain-count");
    const $deviceC = $("#ha-device-count");
    const $hint    = $("#ha-entity-hint");

    const savedArea   = $("#node-input-haAreaId").val();
    const savedLabel  = $("#node-input-haLabelId").val();
    const savedDomain = $("#node-input-haDomain").val();
    const savedDevice = $("#node-input-haDeviceId").val();
    const savedEntity = $("#node-input-haEntityId").val();

    let TOTAL = 0;

    function reset($el, txt) {
      $el.empty().append($("<option/>",{value:"",text:txt}));
    }

    function fmt(a,f) { return `${a} available, ${f} filtered`; }

    function updateCounts(areaCnt, labelCnt, domainCnt) {
      const t = TOTAL;
      $areaC.text(fmt(areaCnt,   t - areaCnt));
      $labelC.text(fmt(labelCnt, areaCnt - labelCnt));
      $domainC.text(fmt(domainCnt, labelCnt - domainCnt));
      $deviceC.text(fmt(domainCnt, t - domainCnt));
    }

    function loadDomains(serverId, area, label, done) {
      reset($domain, "(All component types)");

      const q = { server:serverId };
      if (area)  q.area  = area;
      if (label) q.label = label;

      $.getJSON("amazon-echo-ha-entities/domains", q)
        .done(domains => {
          (domains || []).forEach(d =>
            $domain.append($("<option/>",{
              value:d.domain, text:`${d.domain} (${d.count})`
            }))
          );

          if (savedDomain)
            $domain.val(savedDomain);
        })
        .always(() => done && done());
    }


    function loadDevices(serverId, area, label, domain) {
      reset($device, "(Loading devices...)");

      const q = { server:serverId };
      if (area)  q.area  = area;
      if (label) q.label = label;
      if (domain) q.domain = domain;

      $.getJSON("amazon-echo-ha-entities/devices", q)
        .done(finalDevs => {

          reset($device, "(Select device)");

          (finalDevs || []).forEach(d =>
            $device.append($("<option/>",{value:d.id,text:d.displayName||d.name||d.id}))
          );

          if (savedDevice)
            $device.val(savedDevice);

          // Count steps
          const qA = { server:serverId };
          if (area) qA.area = area;

          const qL = { server:serverId };
          if (area) qL.area = area;
          if (label) qL.label = label;

          $.getJSON("amazon-echo-ha-entities/devices", qA).done(areaDevs => {
            $.getJSON("amazon-echo-ha-entities/devices", qL).done(labelDevs => {
              updateCounts(
                (areaDevs  || []).length,
                (labelDevs || []).length,
                (finalDevs || []).length
              );
            });
          });

          loadEntities(serverId, $device.val());
        })
        .fail(() => {
          reset($device, "(Error)");
          updateCounts(0,0,0);
        });
    }


    function loadEntities(serverId, deviceId) {
      reset($entity, "(Loading entities...)");
      $entity.prop("disabled", true);

      const q = {server:serverId};
      if (deviceId) q.device = deviceId;

      $.getJSON("amazon-echo-ha-entities/entities", q)
        .done(ents => {
          reset($entity, "(Select entity)");

          (ents || []).forEach(e =>
            $entity.append($("<option/>",{value:e.entity_id,text:e.displayName||e.name||e.entity_id}))
          );

          if (savedEntity)
            $entity.val(savedEntity);

          $entity.prop("disabled", false);
          $hint.text($entity.val());
        })
        .fail(() => reset($entity, "(Error)"));
    }


    function loadFilters(serverId) {
      $.getJSON("amazon-echo-ha-entities/filters",{server:serverId})
        .done(data => {

          TOTAL = data.total_devices || 0;

          reset($area, "(All areas)");
          (data.areas || []).forEach(a =>
            $area.append($("<option/>",{value:a.area_id,text:a.name}))
          );

          reset($label, "(All labels)");
          (data.labels || []).forEach(l =>
            $label.append($("<option/>",{value:l.label_id,text:l.name}))
          );

          if (savedArea)  $area.val(savedArea);
          if (savedLabel) $label.val(savedLabel);

          loadDomains(serverId, $area.val(), $label.val(), () => {
            loadDevices(serverId, $area.val(), $label.val(), savedDomain);
          });
        });
    }


    // WRITE FROM UI â†’ HIDDEN INPUTS
    $area.on("change", () => {
      $("#node-input-haAreaId").val($area.val());
      loadDomains($server.val(), $area.val(), $label.val(), () =>
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val())
      );
    });

    $label.on("change", () => {
      $("#node-input-haLabelId").val($label.val());
      loadDomains($server.val(), $area.val(), $label.val(), () =>
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val())
      );
    });

    $domain.on("change", () => {
      $("#node-input-haDomain").val($domain.val());
      loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
    });

    $device.on("change", () => {
      $("#node-input-haDeviceId").val($device.val());
      loadEntities($server.val(), $device.val());
    });

    $entity.on("change", () => {
      $("#node-input-haEntityId").val($entity.val());
      $hint.text($entity.val());
    });


    // CLEAR FILTERS
    $("#ha-clear-filters").on("click", () => {
      $area.val("");  $("#node-input-haAreaId").val("");
      $label.val(""); $("#node-input-haLabelId").val("");
      $domain.val("");$("#node-input-haDomain").val("");

      loadDomains($server.val(), "", "", () =>
        loadDevices($server.val(), "", "", "")
      );
    });


    // INITIAL LOAD
    if ($server.val()) loadFilters($server.val());
  }

});

})();
</script>

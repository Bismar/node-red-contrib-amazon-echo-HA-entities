<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
  </div>

  <div class="form-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- FILTERS -->
  <div class="form-row">
    <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
    <select id="node-input-haAreaId" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
    <select id="node-input-haLabelId" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haDomain"><i class="fa fa-cube"></i> Component type</label>
    <select id="node-input-haDomain" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- DEVICE -->
  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <!-- ENTITY -->
  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- CLEAR FILTER BUTTON (NOW HERE) -->
  <div class="form-row" style="margin-top:6px;">
    <label></label>
    <button type="button" id="ha-clear-filters" class="red-ui-button" style="width:auto; text-align:left;">
      <i class="fa fa-times"></i> Clear all filters
    </button>
  </div>

  <!-- MODES -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs" style="max-height:240px; overflow:auto; background:#f7f7f7; border:1px solid #ddd; padding:6px;"></pre>
  </div>
</script>

<script type="text/javascript">
(function(){

  RED.nodes.registerType("amazon-echo-device-ha-entities",{

    category:"amazon",
    color:"#FFD580",
    icon:"amazon-echo-device.svg",
    inputs:1,
    outputs:1,

    defaults:{
      name:{value:""},
      haServer:{value:"",type:"server",required:true},
      haAreaId:{value:""},
      haLabelId:{value:""},
      haDomain:{value:""},
      haDeviceId:{value:""},
      haEntityId:{value:""}
    },

    label:function(){
      return this.name || "Amazon Echo Device (HA)";
    },

    oneditprepare:function(){

      const $server = $("#node-input-haServer");
      const $area   = $("#node-input-haAreaId");
      const $label  = $("#node-input-haLabelId");
      const $domain = $("#node-input-haDomain");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      const $areaCount   = $("#ha-area-count");
      const $labelCount  = $("#ha-label-count");
      const $domainCount = $("#ha-domain-count");
      const $deviceCount = $("#ha-device-count");

      const $hint     = $("#ha-entity-hint");
      const $modesRow = $("#ha-entity-modes-row");
      const $modes    = $("#ha-entity-modes");
      const $attrsRow = $("#ha-entity-attrs-row");
      const $attrs    = $("#ha-entity-attrs");

      let TOTAL = 0;

      function reset($el,text){
        $el.empty().append($("<option/>",{value:"",text}));
      }

      function updateHint(){
        let e = $entity.val()||"";
        $hint.text(e ? ("Selected entity_id: "+e) : "");
      }

      /* ----------------------------------------------------
       * FULL FIXED: Dynamic Domain Generation (works always)
       * ----------------------------------------------------
       */
      function buildDomainList(serverId, areaId, labelId, restoredDomain){

        const devQ = { server:serverId };
        if(areaId)  devQ.area  = areaId;
        if(labelId) devQ.label = labelId;

        // 1) get devices for the filter
        return $.getJSON("amazon-echo-ha-entities/devices",devQ)
        .then(devices=>{

          const ids = devices.map(d=>d.id);

          // 2) get ALL entities
          return $.getJSON("amazon-echo-ha-entities/entities",{server:serverId})
          .then(all=>{

            const doms = new Set();

            all.forEach(ent=>{
              if(ent.device_id && ids.includes(ent.device_id)){
                doms.add(ent.entity_id.split(".")[0]);
              }
            });

            reset($domain,"(All component types)");
            [...doms].sort().forEach(d=>{
              $domain.append($("<option/>",{value:d,text:d}));
            });

            // restore if valid
            if(restoredDomain && doms.has(restoredDomain))
              $domain.val(restoredDomain);

            return ids; // pass device list onward
          });
        });
      }

      /* ----------------------------------------------------
       * FIXED: loadDevices ALWAYS after domain list refresh
       * ----------------------------------------------------
       */
      function loadDevices(serverId, areaId, labelId, domainId, restoredDev){
        const q = {server:serverId};
        if(areaId)  q.area  = areaId;
        if(labelId) q.label = labelId;
        if(domainId) q.domain = domainId;

        return $.getJSON("amazon-echo-ha-entities/devices",q)
        .then(devs=>{

          reset($device,"(Select device)");
          devs.forEach(d=>{
            $device.append(
              $("<option/>",{value:d.id,text:d.displayName||d.name||d.id})
            );
          });

          if(restoredDev) $device.val(restoredDev);

          updateSequentialCounts(devs.length);

          loadEntities(serverId,$device.val(),$("#node-input-haEntityId").val());

          return devs;
        });
      }

      /* ----------------------------- */

      function updateSequentialCounts(deviceCount){
        const available = deviceCount;
        const filtered = TOTAL - deviceCount;
        const txt = `${available} available, ${filtered} filtered`;
        $areaCount.text(txt);
        $labelCount.text(txt);
        $domainCount.text(txt);
        $deviceCount.text(txt);
      }

      function loadEntities(serverId,deviceId,restored){
        const q = {server:serverId};
        if(deviceId) q.device = deviceId;

        $.getJSON("amazon-echo-ha-entities/entities",q)
        .done(ents=>{

          reset($entity,"(Select entity)");

          ents.forEach(e=>{
            $entity.append(
              $("<option/>",{value:e.entity_id,text:e.displayName||e.name||e.entity_id})
            );
          });

          if(restored) $entity.val(restored);

          updateHint();
        });
      }

      /* ----------------------------------------------------
       * LOAD FILTERS
       * ----------------------------------------------------
       */
      function loadFilters(serverId){

        $.getJSON("amazon-echo-ha-entities/filters",{server:serverId})
        .done(data=>{

          TOTAL = data.total_devices;

          reset($area,"(All areas)");
          data.areas.forEach(a=> $area.append($("<option/>",{value:a.area_id,text:a.name})));

          reset($label,"(All labels)");
          data.labels.forEach(l=> $label.append($("<option/>",{value:l.label_id,text:l.name})));

          const A=$("#node-input-haAreaId").val();
          const L=$("#node-input-haLabelId").val();
          const D=$("#node-input-haDomain").val();

          if(A) $area.val(A);
          if(L) $label.val(L);

          // 1) Build filtered domain list
          buildDomainList(serverId,A,L,D)
          .then(()=>{

            // 2) Then load devices based on new domain list
            loadDevices(
              serverId,
              A, L,
              $("#node-input-haDomain").val(),
              $("#node-input-haDeviceId").val()
            );
          });
        });
      }

      /* ----------------------------------------------------
       * EVENT HANDLERS
       * ----------------------------------------------------
       */

      $server.on("change", ()=>{
        loadFilters($server.val());
      });

      $area.on("change", ()=>{
        const A=$area.val();
        const L=$label.val();

        $("#node-input-haAreaId").val(A);

        buildDomainList($server.val(),A,L,"")
        .then(()=> loadDevices($server.val(),A,L,"",""));
      });

      $label.on("change", ()=>{
        const A=$area.val();
        const L=$label.val();

        $("#node-input-haLabelId").val(L);

        buildDomainList($server.val(),A,L,"")
        .then(()=> loadDevices($server.val(),A,L,"",""));
      });

      $domain.on("change", ()=>{
        const A=$area.val();
        const L=$label.val();
        const D=$domain.val();

        $("#node-input-haDomain").val(D);

        loadDevices($server.val(),A,L,D,$("#node-input-haDeviceId").val());
      });

      $device.on("change", ()=>{
        $("#node-input-haDeviceId").val($device.val());
        loadEntities(
          $server.val(),
          $device.val(),
          $("#node-input-haEntityId").val()
        );
      });

      $entity.on("change", ()=>{
        $("#node-input-haEntityId").val($entity.val());
        updateHint();
      });

      $("#ha-clear-filters").on("click",()=>{

        $area.val("");
        $label.val("");
        $domain.val("");

        $("#node-input-haAreaId").val("");
        $("#node-input-haLabelId").val("");
        $("#node-input-haDomain").val("");

        buildDomainList($server.val(),"","", "")
        .then(()=> loadDevices($server.val(),"","","",""));
      });

      /* ----------------------------------------------------
       * INITIAL LOAD
       * ----------------------------------------------------
       */
      if($server.val()){
        loadFilters($server.val());
      }

    } // oneditprepare
  });

})();
</script>

<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
  </div>

  <div class="form-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- FILTERS -->
  <div class="form-row">
    <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
    <select id="node-input-haAreaId" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
    <select id="node-input-haLabelId" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haDomain"><i class="fa fa-cube"></i> Component type</label>
    <select id="node-input-haDomain" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- CLEAR FILTERS -->
  <div class="form-row" style="margin-top:-4px;">
    <label></label>
    <button type="button" class="red-ui-button" id="ha-clear-filters" style="text-align:left; width:auto;">
      <i class="fa fa-times"></i> Clear all filters
    </button>
  </div>

  <!-- DEVICE + ENTITY -->
  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- MODES + ATTRIBUTES -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs" style="max-height:240px; overflow:auto; background:#f7f7f7; border:1px solid #ddd; padding:6px;"></pre>
  </div>
</script>

<script type="text/html" data-help-name="amazon-echo-device-ha-entities">
  <p>Link an Amazon Echo device with a Home Assistant Device &amp; Entity.</p>
</script>

<script type="text/javascript">
(function () {

  RED.nodes.registerType("amazon-echo-device-ha-entities", {

    category: "amazon",
    color: "#FFD580",
    icon: "amazon-echo-device.svg",
    inputs: 1,
    outputs: 1,

    defaults: {
      name:       { value:"" },
      haServer:   { value:"", type:"server", required:true },
      haAreaId:   { value:"" },
      haLabelId:  { value:"" },
      haDomain:   { value:"" },
      haDeviceId: { value:"" },
      haEntityId: { value:"" }
    },

    label() {
      return this.name || "Amazon Echo Device (HA)";
    },

    oneditprepare() {

      const $server = $("#node-input-haServer");
      const $area   = $("#node-input-haAreaId");
      const $label  = $("#node-input-haLabelId");
      const $domain = $("#node-input-haDomain");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      const $areaCount   = $("#ha-area-count");
      const $labelCount  = $("#ha-label-count");
      const $domainCount = $("#ha-domain-count");
      const $deviceCount = $("#ha-device-count");

      const $hint     = $("#ha-entity-hint");
      const $modesRow = $("#ha-entity-modes-row");
      const $modes    = $("#ha-entity-modes");
      const $attrsRow = $("#ha-entity-attrs-row");
      const $attrs    = $("#ha-entity-attrs");

      let TOTAL_DEVICES = 0;

      function resetSelect($el, txt) {
        $el.empty().append($("<option/>",{value:"",text:txt}));
      }

      function setHint() {
        let eid = $entity.val() || "";
        $hint.text(eid ? "Selected entity_id: " + eid : "");
      }

      /* -------------------------------------
       * FIXED: UNIVERSAL Domain Refresh Logic
       * -------------------------------------
       * Always builds domain list correctly,
       * regardless of:
       * - area = ""
       * - label = ""
       * - both empty
       * - HA device registry inconsistencies
       */
      function updateDomainList(serverId, areaId, labelId, restoredDomain) {

        const q = { server: serverId };
        if (areaId)  q.area  = areaId;

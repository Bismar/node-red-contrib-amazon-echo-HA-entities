<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">

  <!-- NAME -->
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
  </div>

  <!-- SERVER -->
  <div class="form-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- AREA -->
  <div class="form-row">
    <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
    <select id="node-input-haAreaId" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <!-- LABEL -->
  <div class="form-row">
    <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
    <select id="node-input-haLabelId" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <!-- DOMAIN -->
  <div class="form-row">
    <label for="node-input-haDomain"><i class="fa fa-cube"></i> Component type</label>
    <select id="node-input-haDomain" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- DEVICE -->
  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <!-- ENTITY -->
  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- CLEAR FILTERS BUTTON (perfectly left aligned) -->
  <div class="form-row" style="margin-top:8px;">
    <label></label>
    <div style="margin-left:0;">
      <button id="ha-clear-filters" type="button" class="red-ui-button">
        <i class="fa fa-times"></i> Clear all filters
      </button>
    </div>
  </div>

  <!-- MODES -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <!-- ATTRIBUTES -->
  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs"
         style="max-height:240px; overflow:auto; background:#fafafa; border:1px solid #ccc; padding:6px;"></pre>
  </div>

</script>


<script type="text/javascript">
(function () {

RED.nodes.registerType("amazon-echo-device-ha-entities", {
  category: "amazon",
  color: "#FFD580",
  icon: "amazon-echo-device.svg",
  paletteLabel: "amazon echo device (HA)",
  inputs: 1,
  outputs: 1,

  defaults: {
    name:       { value:"" },
    haServer:   { value:"", type:"server" },
    haAreaId:   { value:"" },
    haLabelId:  { value:"" },
    haDomain:   { value:"" },
    haDeviceId: { value:"" },
    haEntityId: { value:"" }
  },

  label() { return this.name || "Amazon Echo Device (HA)"; },

  // ────────────────────────────────────────────────
  // SAVE DATA CORRECTLY
  // ────────────────────────────────────────────────
  oneditsave: function () {
    // Force-save all the dropdown values into config fields
    $("#node-input-haAreaId").val( $("#node-input-haAreaId").val() );
    $("#node-input-haLabelId").val( $("#node-input-haLabelId").val() );
    $("#node-input-haDomain").val( $("#node-input-haDomain").val() );
    $("#node-input-haDeviceId").val( $("#node-input-haDeviceId").val() );
    $("#node-input-haEntityId").val( $("#node-input-haEntityId").val() );
  },

  // ────────────────────────────────────────────────
  // PREPARE UI
  // ────────────────────────────────────────────────
  oneditprepare() {

    const $server = $("#node-input-haServer");
    const $area   = $("#node-input-haAreaId");
    const $label  = $("#node-input-haLabelId");
    const $domain = $("#node-input-haDomain");
    const $device = $("#node-input-haDeviceId");
    const $entity = $("#node-input-haEntityId");

    const $areaC   = $("#ha-area-count");
    const $labelC  = $("#ha-label-count");
    const $domainC = $("#ha-domain-count");
    const $deviceC = $("#ha-device-count");

    const $hint     = $("#ha-entity-hint");
    const $modesRow = $("#ha-entity-modes-row");
    const $modes    = $("#ha-entity-modes");
    const $attrsRow = $("#ha-entity-attrs-row");
    const $attrs    = $("#ha-entity-attrs");

    const $clear = $("#ha-clear-filters");

    let TOTAL = 0;

    function reset($el, txt) {
      $el.empty().append($("<option/>",{value:"",text:txt}));
    }

    function format(av, f) { return `${av} available, ${f} filtered`; }

    function sequential(areaCnt, labelCnt, domainCnt) {
      const total = TOTAL;

      $areaC.text(   format(areaCnt,   total - areaCnt) );
      $labelC.text(  format(labelCnt,  areaCnt - labelCnt) );
      $domainC.text( format(domainCnt, labelCnt - domainCnt) );
      $deviceC.text( format(domainCnt, total - domainCnt) );
    }

    function loadDomains(serverId, area, label, done) {
      reset($domain, "(All component types)");

      const q = { server:serverId };
      if (area) q.area = area;
      if (label) q.label = label;

      $.getJSON("amazon-echo-ha-entities/domains", q)
        .done(domains => {
          (domains || []).forEach(d =>
            $domain.append($("<option/>",{value:d.domain,text:`${d.domain} (${d.count})`}))
          );

          const saved = $("#node-input-haDomain").val();
          if (saved && (domains || []).some(d => d.domain === saved)) {
            $domain.val(saved);
          }
        })
        .always(() => done && done());
    }

    function loadDevices(serverId, area, label, domain) {
      reset($device, "(Loading devices...)");

      const qFinal = { server:serverId };
      if (area)  qFinal.area  = area;
      if (label) qFinal.label = label;
      if (domain) qFinal.domain = domain;

      $.getJSON("amazon-echo-ha-entities/devices", qFinal)
        .done(finalDevs => {
          reset($device, "(Select device)");

          (finalDevs || []).forEach(d =>
            $device.append($("<option/>",{value:d.id,text:d.displayName||d.name||d.id}))
          );

          const saved = $("#node-input-haDeviceId").val();
          if (saved) $device.val(saved);

          // sequential counts
          const qA = {server:serverId};
          if (area) qA.area = area;

          const qL = {server:serverId};
          if (area) qL.area = area;
          if (label) qL.label = label;

          $.getJSON("amazon-echo-ha-entities/devices", qA).done(areaDevs => {
            $.getJSON("amazon-echo-ha-entities/devices", qL).done(labelDevs => {
              sequential(
                (areaDevs  || []).length,
                (labelDevs || []).length,
                (finalDevs || []).length
              );
            });
          });

          loadEntities(serverId, $device.val());
        })
        .fail(() => {
          reset($device,"(Error)");
          sequential(0,0,0);
        });
    }

    function loadEntities(serverId, deviceId) {
      reset($entity, "(Loading entities...)");
      $entity.prop("disabled", true);

      const q = {server:serverId};
      if (deviceId) q.device = deviceId;

      $.getJSON("amazon-echo-ha-entities/entities", q)
        .done(ents => {
          reset($entity, "(Select entity)");

          (ents || []).forEach(e =>
            $entity.append($("<option/>",{value:e.entity_id,text:e.displayName||e.name||e.entity_id}))
          );

          const saved = $("#node-input-haEntityId").val();
          if (saved) $entity.val(saved);

          $entity.prop("disabled", false);
          $hint.text($entity.val());
        })
        .fail(() => reset($entity, "(Error)"));
    }

    function loadFilters(serverId) {
      $.getJSON("amazon-echo-ha-entities/filters", {server:serverId})
        .done(data => {

          TOTAL = data.total_devices || 0;

          reset($area, "(All areas)");
          (data.areas || []).forEach(a =>
            $area.append($("<option/>",{value:a.area_id,text:a.name}))
          );

          reset($label, "(All labels)");
          (data.labels || []).forEach(l =>
            $label.append($("<option/>",{value:l.label_id,text:l.name}))
          );

          if ($("#node-input-haAreaId").val())  $area.val($("#node-input-haAreaId").val());
          if ($("#node-input-haLabelId").val()) $label.val($("#node-input-haLabelId").val());

          loadDomains(serverId, $area.val(), $label.val(), () => {
            if ($("#node-input-haDomain").val()) $domain.val($("#node-input-haDomain").val());
            loadDevices(serverId, $area.val(), $label.val(), $domain.val());
          });

        });
    }

    // ─────────────────── SAVING EVENTS ───────────────────
    $area.on("change", function() {
      $("#node-input-haAreaId").val($area.val());
      loadDomains($server.val(), $area.val(), $label.val(), () => {
        $("#node-input-haDomain").val($domain.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
      });
    });

    $label.on("change", function() {
      $("#node-input-haLabelId").val($label.val());
      loadDomains($server.val(), $area.val(), $label.val(), () => {
        $("#node-input-haDomain").val($domain.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
      });
    });

    $domain.on("change", function() {
      $("#node-input-haDomain").val($domain.val());
      loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
    });

    $device.on("change", function() {
      $("#node-input-haDeviceId").val($device.val());
      loadEntities($server.val(), $device.val());
    });

    $entity.on("change", function() {
      $("#node-input-haEntityId").val($entity.val());
      $hint.text($entity.val());
    });

    // CLEAR FILTERS
    $clear.on("click", function() {
      $area.val("");   $("#node-input-haAreaId").val("");
      $label.val("");  $("#node-input-haLabelId").val("");
      $domain.val(""); $("#node-input-haDomain").val("");

      loadDomains($server.val(), "", "", () =>
        loadDevices($server.val(), "", "", "")
      );
    });

    // INIT
    if ($server.val()) loadFilters($server.val());

  }

});

})();
</script>

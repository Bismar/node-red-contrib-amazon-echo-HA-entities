<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
  </div>

  <div class="form-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- AREA -->
  <div class="form-row">
    <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
    <select id="node-input-haAreaId" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <!-- LABEL -->
  <div class="form-row">
    <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
    <select id="node-input-haLabelId" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <!-- DOMAIN -->
  <div class="form-row">
    <label for="node-input-haDomain"><i class="fa fa-cube"></i> Component type</label>
    <select id="node-input-haDomain" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- DEVICE -->
  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <!-- ENTITY -->
  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- CLEAR FILTERS BUTTON (left aligned under entity) -->
  <div class="form-row" style="margin-top:6px;">
    <label></label>
    <button type="button" id="ha-clear-filters" class="red-ui-button" style="margin-left:0;">
      <i class="fa fa-times"></i> Clear all filters
    </button>
  </div>

  <!-- MODES -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <!-- ATTRIBUTES -->
  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs"
      style="max-height:240px; overflow:auto; background:#fafafa; border:1px solid #ddd; padding:6px; border-radius:3px;"></pre>
  </div>

</script>

<script type="text/html" data-help-name="amazon-echo-device-ha-entities">
  <p>
    Select an Amazon Echo Device entity in Home Assistant, with optional Area / Label / Component Type filtering.
  </p>
</script>

<script type="text/javascript">
(function () {

  RED.nodes.registerType("amazon-echo-device-ha-entities", {
    category: "amazon",
    color: "#FFD580",
    icon: "amazon-echo-device.svg",
    paletteLabel: "amazon echo device (HA)",
    inputs: 1,
    outputs: 1,

    defaults: {
      name:       { value: "" },
      haServer:   { value: "", type: "server", required: true },
      haAreaId:   { value: "" },
      haLabelId:  { value: "" },
      haDomain:   { value: "" },
      haDeviceId: { value: "" },
      haEntityId: { value: "" }
    },

    label: function () { return this.name || "Amazon Echo Device (HA)"; },

    oneditprepare: function () {

      const $server = $("#node-input-haServer");
      const $area   = $("#node-input-haAreaId");
      const $label  = $("#node-input-haLabelId");
      const $domain = $("#node-input-haDomain");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      const $areaCount   = $("#ha-area-count");
      const $labelCount  = $("#ha-label-count");
      const $domainCount = $("#ha-domain-count");
      const $deviceCount = $("#ha-device-count");

      const $hint = $("#ha-entity-hint");

      let TOTAL = 0;

      function resetSelect($el, txt) {
        $el.empty().append($("<option/>", { value: "", text: txt }));
      }

      function formatCount(avail, filtered) {
        return `${avail} available, ${filtered} filtered`;
      }

      // SET SEQUENTIAL COMMENTS (Option 1)
      function updateSequentialComments(areaCount, labelCount, domainCount) {
        const total = TOTAL;

        const filteredArea   = total - areaCount;
        const filteredLabel  = areaCount - labelCount;
        const filteredDomain = labelCount - domainCount;
        const filteredDevice = total - domainCount;

        $areaCount.text(formatCount(areaCount, filteredArea));
        $labelCount.text(formatCount(labelCount, filteredLabel));
        $domainCount.text(formatCount(domainCount, filteredDomain));
        $deviceCount.text(formatCount(domainCount, filteredDevice));
      }

      // Load DOMAINS from new backend endpoint
      function loadDomains(serverId, area, label, cb) {
        resetSelect($domain, "(All component types)");

        const query = { server: serverId };
        if (area) query.area = area;
        if (label) query.label = label;

        $.getJSON("amazon-echo-ha-entities/domains", query)
          .done(domains => {
            (domains || []).forEach(d => {
              $domain.append(
                $("<option/>", {
                  value: d.domain,
                  text: `${d.domain} (${d.count})`
                })
              );
            });

            const saved = $("#node-input-haDomain").val();
            if (saved && (domains || []).some(d => d.domain === saved))
              $domain.val(saved);
          })
          .always(() => cb && cb());
      }

      function loadDevices(serverId, area, label, domain) {
        resetSelect($device, "(Loading devices...)");

        const q = { server: serverId };
        if (area) q.area = area;
        if (label) q.label = label;
        if (domain) q.domain = domain;

        $.getJSON("amazon-echo-ha-entities/devices", q)
          .done(devs => {
            resetSelect($device, "(Select device)");
            (devs || []).forEach(d => {
              $device.append($("<option/>", { value: d.id, text: d.displayName || d.name || d.id }));
            });

            // Sequential comment update
            // 1) area-only
            const aq = { server: serverId };
            if (area) aq.area = area;

            $.getJSON("amazon-echo-ha-entities/devices", aq)
              .done(areaDevs => {
                const areaCount = (areaDevs || []).length;

                // 2) label
                const lq = { server: serverId };
                if (area) lq.area = area;
                if (label) lq.label = label;

                $.getJSON("amazon-echo-ha-entities/devices", lq)
                  .done(labelDevs => {
                    const labelCount = (labelDevs || []).length;

                    // 3) domain (final)
                    const domainCount = (devs || []).length;

                    updateSequentialComments(areaCount, labelCount, domainCount);
                  });
              });

            loadEntities(serverId, $device.val());
          })
          .fail(() => {
            resetSelect($device, "(Error)");
            updateSequentialComments(0, 0, 0);
          });
      }

      function loadEntities(serverId, deviceId) {
        resetSelect($entity, "(Loading entities...)");
        $entity.prop("disabled", true);

        const q = { server: serverId };
        if (deviceId) q.device = deviceId;

        $.getJSON("amazon-echo-ha-entities/entities", q)
          .done(ents => {
            resetSelect($entity, "(Select entity)");
            (ents || []).forEach(e => {
              $entity.append(
                $("<option/>", {
                  value: e.entity_id,
                  text: e.displayName || e.name || e.entity_id
                })
              );
            });

            const saved = $("#node-input-haEntityId").val();
            if (saved) $entity.val(saved);

            $entity.prop("disabled", false);
            $hint.text($entity.val() || "");
          })
          .fail(() => {
            resetSelect($entity, "(Error)");
            $hint.text("");
          });
      }

      function loadFilters(serverId) {
        if (!serverId) {
          resetSelect($area, "(All areas)");
          resetSelect($label, "(All labels)");
          resetSelect($domain, "(All component types)");
          resetSelect($device, "(Select device)");
          resetSelect($entity, "(Select entity)");
          updateSequentialComments(0, 0, 0);
          return;
        }

        $.getJSON("amazon-echo-ha-entities/filters", { server: serverId })
          .done(data => {
            TOTAL = data.total_devices || 0;

            resetSelect($area, "(All areas)");
            (data.areas || []).forEach(a =>
              $area.append($("<option/>", { value: a.area_id, text: a.name }))
            );

            resetSelect($label, "(All labels)");
            (data.labels || []).forEach(l =>
              $label.append($("<option/>", { value: l.label_id, text: l.name }))
            );

            if ($("#node-input-haAreaId").val())  $area.val($("#node-input-haAreaId").val());
            if ($("#node-input-haLabelId").val()) $label.val($("#node-input-haLabelId").val());

            loadDomains(serverId, $area.val(), $label.val(), () => {
              if ($("#node-input-haDomain").val()) $domain.val($("#node-input-haDomain").val());
              loadDevices(serverId, $area.val(), $label.val(), $domain.val());
            });
          });
      }

      // EVENTS
      $server.on("change", () => loadFilters($server.val()));

      $area.on("change", () => {
        $("#node-input-haAreaId").val($area.val());
        loadDomains($server.val(), $area.val(), $label.val(), () => {
          $("#node-input-haDomain").val($domain.val());
          loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
        });
      });

      $label.on("change", () => {
        $("#node-input-haLabelId").val($label.val());
        loadDomains($server.val(), $area.val(), $label.val(), () => {
          $("#node-input-haDomain").val($domain.val());
          loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
        });
      });

      $domain.on("change", () => {
        $("#node-input-haDomain").val($domain.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val());
      });

      $device.on("change", () => {
        $("#node-input-haDeviceId").val($device.val());
        loadEntities($server.val(), $device.val());
      });

      $entity.on("change", () => {
        $("#node-input-haEntityId").val($entity.val());
        $hint.text($entity.val());
      });

      $("#ha-clear-filters").on("click", () => {
        $area.val("");
        $label.val("");
        $domain.val("");
        $("#node-input-haAreaId").val("");
        $("#node-input-haLabelId").val("");
        $("#node-input-haDomain").val("");
        loadDomains($server.val(), "", "", () => loadDevices($server.val(), "", "", ""));
      });

      // Initial load
      if ($server.val()) loadFilters($server.val());
    }
  });

})();
</script>

<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
  </div>

  <div class="form-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- AREA FILTER -->
  <div class="form-row">
    <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
    <select id="node-input-haAreaId" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <!-- LABEL FILTER -->
  <div class="form-row">
    <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
    <select id="node-input-haLabelId" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <!-- DOMAIN FILTER -->
  <div class="form-row">
    <label for="node-input-haDomain"><i class="fa fa-cube"></i> Component type</label>
    <select id="node-input-haDomain" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- DEVICE -->
  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <!-- ENTITY -->
  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- CLEAR FILTERS BUTTON (FIXED LEFT ALIGNMENT UNDER LAST DROPDOWN) -->
  <div class="form-row" style="margin-top:6px;">
    <label></label>
    <button id="ha-clear-filters"
            class="red-ui-button"
            style="width:auto; text-align:left; margin-left:0 !important;">
      <i class="fa fa-times"></i> Clear all filters
    </button>
  </div>

  <!-- MODES -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <!-- ATTRIBUTES -->
  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs"
         style="max-height:240px; overflow:auto; background:#f7f7f7; border:1px solid #ddd; padding:6px;"></pre>
  </div>

</script>

<script type="text/javascript">
(function(){

  RED.nodes.registerType("amazon-echo-device-ha-entities", {

    category:"amazon",
    color:"#FFD580",
    icon:"amazon-echo-device.svg",
    inputs:1,
    outputs:1,

    defaults:{
      name:{value:""},
      haServer:{value:"",type:"server"},
      haAreaId:{value:""},
      haLabelId:{value:""},
      haDomain:{value:""},
      haDeviceId:{value:""},
      haEntityId:{value:""}
    },

    label(){ return this.name || "Amazon Echo Device (HA)"; },

    oneditprepare(){

      /* ELEMENTS */
      const $server = $("#node-input-haServer");
      const $area   = $("#node-input-haAreaId");
      const $label  = $("#node-input-haLabelId");
      const $domain = $("#node-input-haDomain");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      const $areaCount   = $("#ha-area-count");
      const $labelCount  = $("#ha-label-count");
      const $domainCount = $("#ha-domain-count");
      const $deviceCount = $("#ha-device-count");

      const $hint = $("#ha-entity-hint");

      function reset($el,text){
        $el.empty().append($("<option/>",{value:"",text}));
      }

      /* --------------------------------------------
       * CORE FIX: Build domains DIRECTLY from entities
       * -------------------------------------------- */
      function buildDomainList(serverId, areaId, labelId, restoredDomain){

        return $.getJSON("amazon-echo-ha-entities/entities", {server:serverId})
        .then(allEntities => {

          const filtered = allEntities.filter(e => {

            if (areaId && e.area_id !== areaId) return false;

            if (labelId && !(Array.isArray(e.labels) && e.labels.includes(labelId)))
              return false;

            return true;
          });

          const domains = [...new Set(filtered.map(e => e.entity_id.split(".")[0]))].sort();

          reset($domain,"(All component types)");

          domains.forEach(d => {
            $domain.append($("<option/>",{value:d,text:d}));
          });

          if (restoredDomain && domains.includes(restoredDomain))
            $domain.val(restoredDomain);

          return filtered;
        });
      }

      /* -------------------------------
       * Load devices DIRECTLY from entities
       * ------------------------------- */
      function loadDevices(serverId, areaId, labelId, domainId, restoredDeviceId){

        return $.getJSON("amazon-echo-ha-entities/entities",{server:serverId})
        .then(allEntities => {

          const ents = allEntities.filter(e => {

            if(areaId && e.area_id !== areaId) return false;

            if(labelId &&
               !(Array.isArray(e.labels) && e.labels.includes(labelId)))
                return false;

            if(domainId &&
               e.entity_id.split(".")[0] !== domainId)
                return false;

            return true;
          });

          const deviceIds = [...new Set(ents.map(e=>e.device_id))];

          reset($device,"(Select device)");

          deviceIds.forEach(id => {
            $device.append($("<option/>",{value:id,text:id}));
          });

          if(restoredDeviceId && deviceIds.includes(restoredDeviceId))
            $device.val(restoredDeviceId);

          updateCounts(deviceIds.length);

          loadEntities(serverId,$device.val(),$("#node-input-haEntityId").val());
        });
      }

      function updateCounts(n){
        const txt = `${n} available`;
        $areaCount.text(txt);
        $labelCount.text(txt);
        $domainCount.text(txt);
        $deviceCount.text(txt);
      }

      function loadEntities(serverId,deviceId,restored){

        const q = {server:serverId};
        if(deviceId) q.device = deviceId;

        $.getJSON("amazon-echo-ha-entities/entities",q)
        .done(ents=>{
          reset($entity,"(Select entity)");
          ents.forEach(e =>
            $entity.append($("<option/>",{value:e.entity_id,text:e.entity_id}))
          );
          if(restored) $entity.val(restored);
          $hint.text($entity.val());
        });
      }

      /* --------------------------------------------
       * MASTER LOAD SEQUENCE
       * -------------------------------------------- */

      function reloadAll(){

        const A=$area.val();
        const L=$label.val();
        const D=$domain.val();

        buildDomainList($server.val(),A,L,D)
        .then(()=> loadDevices($server.val(),A,L,$domain.val(),$("#node-input-haDeviceId").val()));
      }

      /* EVENT HOOKS */

      $server.on("change", reloadAll);

      $area.on("change", function(){
        $("#node-input-haAreaId").val($area.val());
        reloadAll();
      });

      $label.on("change", function(){
        $("#node-input-haLabelId").val($label.val());
        reloadAll();
      });

      $domain.on("change", function(){
        $("#node-input-haDomain").val($domain.val());
        reloadAll();
      });

      $device.on("change", function(){
        $("#node-input-haDeviceId").val($device.val());
        loadEntities($server.val(),$device.val(),$("#node-input-haEntityId").val());
      });

      $entity.on("change", function(){
        $("#node-input-haEntityId").val($entity.val());
        $hint.text($entity.val());
      });

      $("#ha-clear-filters").on("click", function(){
        $area.val("");  $("#node-input-haAreaId").val("");
        $label.val(""); $("#node-input-haLabelId").val("");
        $domain.val("");$("#node-input-haDomain").val("");
        reloadAll();
      });

      /* INIT */
      if ($server.val()) reloadAll();

    }
  });

})();
</script>

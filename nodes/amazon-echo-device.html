<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
  </div>

  <div class="form-row" id="ha-server-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <!-- FILTERS -->
  <div class="form-row">
    <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
    <select id="node-input-haAreaId" style="width:100%"></select>
    <div class="form-tips" id="ha-area-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
    <select id="node-input-haLabelId" style="width:100%"></select>
    <div class="form-tips" id="ha-label-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haDomain"><i class="fa fa-cube"></i> Component type</label>
    <select id="node-input-haDomain" style="width:100%"></select>
    <div class="form-tips" id="ha-domain-count"></div>
  </div>

  <!-- CLEAR FILTERS -->
  <div class="form-row">
    <label></label>
    <button type="button" class="red-ui-button" id="ha-clear-filters">
      <i class="fa fa-times"></i> Clear all filters
    </button>
  </div>

  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
    <div class="form-tips" id="ha-device-count"></div>
  </div>

  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>

  <div class="form-tips" id="ha-entity-hint"></div>

  <!-- MODES + ATTRS -->
  <div class="form-row" id="ha-entity-modes-row" style="display:none;">
    <label><i class="fa fa-sliders"></i> Available modes</label>
    <div id="ha-entity-modes" class="form-tips"></div>
  </div>

  <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
    <label><i class="fa fa-list"></i> Attributes</label>
    <pre id="ha-entity-attrs" style="max-height:240px; overflow:auto;"></pre>
  </div>
</script>

<script type="text/html" data-help-name="amazon-echo-device-ha-entities">
  <p>Link an Amazon Echo device with a Home Assistant Device &amp; Entity.</p>
  <ul>
    <li>Filter by <b>Area</b>, <b>Label</b>, <b>Component type</b>.</li>
    <li>Select a <b>Device</b> then an <b>Entity</b>.</li>
    <li>Modes and attributes preview shown automatically.</li>
  </ul>
</script>

<script type="text/javascript">
(function () {
  RED.nodes.registerType("amazon-echo-device-ha-entities", {
    category: "amazon",
    color: "#FFD580",
    icon: "amazon-echo-device.svg",
    inputs: 1,
    outputs: 1,
    paletteLabel: "amazon echo device (HA)",
    defaults: {
      name:       { value: "" },
      haServer:   { value: "", type: "server", required: true },
      haAreaId:   { value: "" },
      haLabelId:  { value: "" },
      haDomain:   { value: "" },
      haDeviceId: { value: "" },
      haEntityId: { value: "" }
    },
    label: function () {
      return this.name || "Amazon Echo Device (HA)";
    },

    oneditprepare: function () {
      const $server = $("#node-input-haServer");
      const $area   = $("#node-input-haAreaId");
      const $label  = $("#node-input-haLabelId");
      const $domain = $("#node-input-haDomain");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      const $areaCount   = $("#ha-area-count");
      const $labelCount  = $("#ha-label-count");
      const $domainCount = $("#ha-domain-count");
      const $deviceCount = $("#ha-device-count");

      const $hint    = $("#ha-entity-hint");
      const $modes   = $("#ha-entity-modes");
      const $modesRow= $("#ha-entity-modes-row");
      const $attrs   = $("#ha-entity-attrs");
      const $attrsRow= $("#ha-entity-attrs-row");

      let TOTAL_DEVICES = 0;

      function resetSelect($sel, firstText) {
        $sel.empty().append($("<option/>",{value:"",text:firstText}));
      }

      function setHint() {
        const eid = $entity.val() || "";
        $hint.text(eid ? ("Selected entity_id: " + eid) : "");
      }

      function showEntityInfo(info) {
        if (!info || !info.entity_id) {
          $modesRow.hide(); $attrsRow.hide();
          $modes.empty(); $attrs.text(""); return;
        }
        const dm = info.detected_modes || {};
        const keys = Object.keys(dm);
        if (keys.length) {
          $modes.empty();
          keys.forEach(k => {
            const div = $("<div/>").css("margin-bottom","4px");
            div.append($("<strong/>").text(k));
            dm[k].forEach(v => {
              div.append($("<span/>").text(v).css({
                display:"inline-block", padding:"2px 6px", margin:"2px",
                border:"1px solid #bbb", borderRadius:"999px"
              }));
            });
            $modes.append(div);
          });
          $modesRow.show();
        } else $modesRow.hide();

        if (info.attributes) {
          $attrs.text(JSON.stringify(info.attributes,null,2));
          $attrsRow.show();
        } else {
          $attrs.text(""); $attrsRow.hide();
        }
      }

      /** -----------------------------
       * SEQUENTIAL FILTER COUNT SYSTEM
       * ----------------------------- */
      function updateSequentialCounts(serverId, areaId, labelId, domain, finalDevicesCount) {
        const total = TOTAL_DEVICES || 0;
        const labelText = (a,f) => `${a} available, ${f} filtered`;

        if (!serverId || !total) {
          const f = total - finalDevicesCount;
          $areaCount.text(labelText(finalDevicesCount, f));
          $labelCount.text(labelText(finalDevicesCount, f));
          $domainCount.text(labelText(finalDevicesCount, f));
          $deviceCount.text(labelText(finalDevicesCount, f));
          return;
        }

        let areaAvail  = total;
        let labelAvail = total;
        let domainAvail= finalDevicesCount;

        const baseQ = { server: serverId };

        function loadCount(q, cb){
          $.getJSON("amazon-echo-ha-entities/devices", q)
            .done(d => cb((d||[]).length))
            .fail(() => cb(total));
        }

        function apply() {
          const areaF   = total       - areaAvail;
          const labelF  = areaAvail   - labelAvail;
          const domainF = labelAvail  - domainAvail;
          const deviceF = total       - domainAvail;

          $areaCount.text(labelText(areaAvail,   areaF));
          $labelCount.text(labelText(labelAvail, labelF));
          $domainCount.text(labelText(domainAvail, domainF));
          $deviceCount.text(labelText(domainAvail, deviceF));
        }

        function afterArea() {
          if (labelId) {
            const q2 = Object.assign({}, baseQ, areaId?{area:areaId}:{}, {label:labelId});
            loadCount(q2,c=>{
              labelAvail=c;
              if (!domain) domainAvail=c;
              apply();
            });
          } else {
            labelAvail = areaAvail;
            if (!domain) domainAvail = labelAvail;
            apply();
          }
        }

        if (areaId) {
          const q1 = Object.assign({}, baseQ, {area:areaId});
          loadCount(q1,c=>{ areaAvail=c; afterArea(); });
        } else {
          areaAvail=total;
          afterArea();
        }
      }

      /** -----------------------------------------
       * FILTER DOMAINS Dynamically (Area + Label)
       * ----------------------------------------- */
      function updateDomainList(serverId, areaId, labelId, restoredDomain) {
        const baseQ = { server: serverId };
        if (areaId)  baseQ.area  = areaId;
        if (labelId) baseQ.label = labelId;

        $.getJSON("amazon-echo-ha-entities/devices", baseQ).done(devices => {
          const devIds = devices.map(d=>d.id);

          $.getJSON("amazon-echo-ha-entities/entities",{server:serverId})
            .done(all=>{
              const doms=new Set();
              all.forEach(e=>{
                if (devIds.includes(e.device_id)) {
                  doms.add(e.entity_id.split(".")[0]);
                }
              });
              resetSelect($domain,"(All component types)");
              [...doms].sort().forEach(d=>{
                $domain.append($("<option/>",{value:d,text:d}));
              });
              if (restoredDomain && doms.has(restoredDomain)) $domain.val(restoredDomain);
            });
        });
      }

      /** -----------------------------
       * DEVICE + ENTITY LOADERS
       * ----------------------------- */
      function loadEntities(serverId, deviceId, restored) {
        resetSelect($entity,"(Loading entities...)");
        const q = { server:serverId };
        if (deviceId) q.device=deviceId;

        $.getJSON("amazon-echo-ha-entities/entities", q)
          .done(ents=>{
            resetSelect($entity,"(Select entity)");
            ents.forEach(e=>{
              $entity.append(
                $("<option/>",{value:e.entity_id,text:e.displayName||e.name||e.entity_id})
              );
            });
            if (restored) $entity.val(restored);
            setHint();
            if ($entity.val()) loadEntityInfo(serverId, $entity.val());
          });
      }

      function loadEntityInfo(serverId,eid){
        if (!eid) return showEntityInfo(null);
        $.getJSON("amazon-echo-ha-entities/entity_info",{server:serverId,entity:eid})
          .done(info=>showEntityInfo(info))
          .fail(()=>showEntityInfo(null));
      }

      function loadDevices(serverId, areaId, labelId, domain, restoredDeviceId) {
        resetSelect($device,"(Loading devices...)");

        const q = { server:serverId };
        if (areaId)  q.area = areaId;
        if (labelId) q.label = labelId;
        if (domain)  q.domain = domain;

        $.getJSON("amazon-echo-ha-entities/devices", q)
          .done(devs=>{
            resetSelect($device,"(Select device)");
            devs.forEach(d=>{
              $device.append(
                $("<option/>",{value:d.id,text:d.displayName||d.name||d.id})
              );
            });

            if (restoredDeviceId) $device.val(restoredDeviceId);

            updateSequentialCounts(serverId, areaId, labelId, domain, devs.length);

            loadEntities(serverId, $device.val(), $("#node-input-haEntityId").val());
          });
      }

      /** ---------------------------
       * RESET ALL (full reset)
       * --------------------------- */
      function fullReset() {
        resetSelect($area,"(All areas)");
        resetSelect($label,"(All labels)");
        resetSelect($domain,"(All component types)");
        resetSelect($device,"(Select device)");
        resetSelect($entity,"(Select entity)");
        $modes.empty(); $attrs.empty();
        $modesRow.hide(); $attrsRow.hide();
        $areaCount.text(""); $labelCount.text(""); $domainCount.text(""); $deviceCount.text("");
        TOTAL_DEVICES = 0;
      }

      /** ---------------------------
       * LOAD FILTERS
       * --------------------------- */
      function loadFilters(serverId){
        if (!serverId) return fullReset();

        $.getJSON("amazon-echo-ha-entities/filters",{server:serverId})
          .done(data=>{
            TOTAL_DEVICES = data.total_devices||0;

            resetSelect($area,"(All areas)");
            data.areas.forEach(a=> $area.append($("<option/>",{value:a.area_id,text:a.name})));

            resetSelect($label,"(All labels)");
            data.labels.forEach(l=> $label.append($("<option/>",{value:l.label_id,text:l.name})));

            // Restore selections
            const Rarea   = $("#node-input-haAreaId").val();
            const Rlabel  = $("#node-input-haLabelId").val();
            const Rdomain = $("#node-input-haDomain").val();

            if (Rarea)  $area.val(Rarea);
            if (Rlabel) $label.val(Rlabel);

            updateDomainList(serverId, Rarea, Rlabel, Rdomain);

            loadDevices(serverId, Rarea, Rlabel, Rdomain, $("#node-input-haDeviceId").val());
          });
      }

      /** ---------------------------
       * EVENT HANDLERS
       * --------------------------- */
      $server.on("change",()=> loadFilters($server.val()));

      $area.on("change",()=>{
        $("#node-input-haAreaId").val($area.val());
        updateDomainList($server.val(), $area.val(), $label.val(), "");
        loadDevices($server.val(), $area.val(), $label.val(), "", "");
      });

      $label.on("change",()=>{
        $("#node-input-haLabelId").val($label.val());
        updateDomainList($server.val(), $area.val(), $label.val(), "");
        loadDevices($server.val(), $area.val(), $label.val(), "", "");
      });

      $domain.on("change",()=>{
        $("#node-input-haDomain").val($domain.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val(), $("#node-input-haDeviceId").val());
      });

      $device.on("change",()=>{
        $("#node-input-haDeviceId").val($device.val());
        loadEntities($server.val(), $device.val(), $("#node-input-haEntityId").val());
      });

      $entity.on("change",()=>{
        $("#node-input-haEntityId").val($entity.val());
        setHint();
        loadEntityInfo($server.val(), $entity.val());
      });

      $("#ha-clear-filters").on("click", function () {
        $area.val(""); $label.val(""); $domain.val("");
        $("#node-input-haAreaId").val("");
        $("#node-input-haLabelId").val("");
        $("#node-input-haDomain").val("");
        updateDomainList($server.val(),"","", "");
        loadDevices($server.val(),"","","","");
      });

      /** ---------------------------
       * INIT LOAD
       * --------------------------- */
      if ($server.val()) loadFilters($server.val());
      else fullReset();
    }
  });
})();
</script>
